{% extends "Echo_app/base.html" %}
{% load static %}

{% block title %}Meus Salvos{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'Echo_app/css/dashboard.css' %}?v={% now 'U' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* --- ESTRUTURA GERAL --- */
    body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

    .main-wrapper { 
        padding: 40px 0; 
        display: flex; 
        justify-content: center; 
        padding-bottom: 100px; /* Espaço extra para barra flutuante */
    }
    
    .salvos-container { 
        width: 100%; 
        max-width: 900px; /* Levemente reduzido para ficar mais compacto e elegante */
        margin: 0 auto; 
        padding: 0 20px; 
    }

    /* --- HEADER --- */
    .page-header { text-align: center; margin-bottom: 35px; }
    .page-title { font-size: 2.2rem; font-weight: 800; color: #1a1a1a; margin: 0; letter-spacing: -0.5px; }

    /* --- BARRA DE PESQUISA & BOTÃO DE AÇÃO --- */
    .search-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 40px;
        max-width: 100%;
    }

    .search-form { 
        flex-grow: 1; 
        position: relative; 
    }

    .search-input { 
        width: 100%; 
        height: 52px; /* Altura confortável */
        background-color: #fff; 
        border: 1px solid #e0e0e0; 
        border-radius: 12px; /* Bordas levemente arredondadas, mais moderno que pílula total */
        padding: 0 50px 0 20px; 
        font-size: 1rem; 
        outline: none; 
        transition: all 0.2s; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
    }
    
    .search-input:focus { border-color: #ed1c24; box-shadow: 0 4px 12px rgba(237, 28, 36, 0.1); }
    
    .search-btn-icon { 
        position: absolute; 
        right: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        border: none; 
        background: transparent; 
        color: #999; 
        cursor: pointer; 
        font-size: 1.1rem; 
        transition: color 0.2s;
    }
    .search-btn-icon:hover { color: #ed1c24; }
    
    /* Botão Quadrado/Arredondado de Criar (+) */
    .btn-create-folder {
        height: 52px;
        width: 52px;
        min-width: 52px;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #333;
        font-size: 1.2rem;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .btn-create-folder:hover {
        border-color: #ed1c24;
        color: #ed1c24;
        background-color: #fff5f5;
        transform: translateY(-2px);
    }

    /* --- TÍTULOS DE SEÇÃO --- */
    .section-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .section-title { 
        font-size: 1.2rem; 
        font-weight: 700; 
        color: #333; 
        margin: 0; 
    }
    
    /* Botão "Selecionar" discreto */
    .btn-toggle-select {
        font-size: 0.9rem;
        color: #666;
        font-weight: 600;
        background: transparent;
        border: 1px solid transparent;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    .btn-toggle-select:hover { background-color: #e9ecef; color: #333; }
    
    .btn-toggle-select.cancel-mode { color: #dc3545; background-color: #fff0f0; }
    .btn-toggle-select.cancel-mode:hover { background-color: #ffe6e6; }


    /* --- COLEÇÕES (SCROLL) --- */
    .collections-scroll { 
        display: flex; 
        overflow-x: auto; 
        gap: 16px; 
        padding: 4px; 
        margin-bottom: 40px; 
        scrollbar-width: none; 
    }
    .collections-scroll::-webkit-scrollbar { display: none; }

    .collection-card { 
        min-width: 130px; 
        width: 130px; 
        display: flex; 
        flex-direction: column; 
        cursor: pointer; 
        transition: transform 0.2s; 
        text-decoration: none;
    }
    .collection-card:hover { transform: translateY(-3px); }

    .collection-thumb-box { 
        width: 100%; 
        height: 100px; 
        border-radius: 12px; 
        overflow: hidden; 
        margin-bottom: 10px; 
        background-color: #f1f3f5; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        position: relative; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .collection-thumb { width: 100%; height: 100%; object-fit: cover; }
    
    /* Card "Nova Coleção" */
    .create-collection-box { 
        background-color: #fff; 
        border: 2px dashed #ccc; 
        color: #999; 
        font-size: 1.5rem; 
        transition: all 0.2s;
    }
    .collection-card:hover .create-collection-box { 
        border-color: #ed1c24; 
        color: #ed1c24; 
        background-color: #fff5f5; 
    }
    
    .collection-name { font-size: 0.9rem; font-weight: 600; color: #333; text-align: center; line-height: 1.2; margin: 0;}
    .collection-count { font-size: 0.75rem; color: #999; text-align: center; margin-top: 2px;}


    /* --- GRID DE NOTÍCIAS --- */
    .news-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 20px; 
    }
    
    .news-card { 
        position: relative; 
        border-radius: 12px; 
        overflow: hidden; 
        aspect-ratio: 3/4; 
        background-color: #e9ecef; 
        cursor: pointer; 
        transition: transform 0.2s, box-shadow 0.2s; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .news-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    
    .card-img { width: 100%; height: 100%; object-fit: cover; }
    
    .card-overlay { 
        position: absolute; bottom: 0; left: 0; right: 0; 
        background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 60%, transparent 100%); 
        padding: 15px; 
        display: flex; flex-direction: column; justify-content: flex-end; height: 65%; 
    }
    .card-title { color: white; font-weight: 700; margin: 0; font-size: 0.95rem; line-height: 1.35; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }


    /* --- SELEÇÃO (CHECKBOX) --- */
    .selection-check {
        position: absolute; top: 10px; right: 10px; width: 24px; height: 24px;
        background: rgba(255,255,255,0.9); border: 2px solid #ccc; border-radius: 50%;
        display: none; align-items: center; justify-content: center; z-index: 10;
        transition: all 0.2s;
    }
    body.selection-mode .selection-check { display: flex; }
    
    .news-card.selected { transform: scale(0.96); box-shadow: 0 0 0 3px #ed1c24; }
    .news-card.selected .selection-check { background-color: #ed1c24; border-color: #ed1c24; color: white; }
    .news-card.selected .selection-check::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7rem; }


    /* --- EMPTY STATE (BONITO) --- */
    .empty-state-container {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        background-color: #fff;
        border-radius: 12px;
        border: 1px dashed #e0e0e0;
        text-align: center;
    }
    
    .empty-icon-circle {
        width: 70px; height: 70px;
        background-color: #f8f9fa;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 15px;
        color: #adb5bd;
        font-size: 1.8rem;
    }
    
    .empty-title { font-size: 1.1rem; font-weight: 600; color: #495057; margin: 0 0 5px 0; }
    .empty-desc { font-size: 0.9rem; color: #868e96; margin-bottom: 20px; max-width: 300px; }
    
    .btn-empty-action {
        color: #ed1c24; font-weight: 600; text-decoration: none; font-size: 0.95rem;
    }
    .btn-empty-action:hover { text-decoration: underline; }


    /* --- BARRA FLUTUANTE INFERIOR --- */
    .floating-action-bar {
        position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
        background-color: #212529; color: white; padding: 12px 25px; border-radius: 50px;
        display: flex; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9999;
    }
    body.selection-mode .floating-action-bar { transform: translateX(-50%) translateY(0); }
    
    .selected-count { font-weight: 600; font-size: 0.95rem; border-right: 1px solid #495057; padding-right: 15px; }
    
    .btn-action-float {
        background: #ed1c24; color: white; border: none; padding: 8px 18px; border-radius: 20px;
        font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;
        transition: background 0.2s;
    }
    .btn-action-float:hover { background: #c5161d; }
    .btn-action-float:disabled { background: #495057; cursor: not-allowed; opacity: 0.7; }


    /* --- MODAL --- */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-box { background: #fff; width: 90%; max-width: 380px; padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .modal-title { margin: 0 0 10px 0; color: #333; font-size: 1.3rem; }
    .modal-input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 8px; margin: 20px 0; font-size: 1rem; outline: none; }
    .modal-input:focus { border-color: #ed1c24; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; }
    .btn-modal { padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: opacity 0.2s; }
    .btn-cancel { background: #f1f3f5; color: #495057; }
    .btn-cancel:hover { background: #e9ecef; }
    .btn-confirm { background: #ed1c24; color: #fff; }
    .btn-confirm:hover { background: #c5161d; }

</style>
{% endblock %}

{% block content %}

<div class="main-wrapper">
    <div class="salvos-container">

        <div class="page-header">
            <h2 class="page-title">Meus Salvos</h2>
        </div>

        <div class="search-row">
            <form method="GET" action="{% url 'Echo_app:noticias_salvas' %}" class="search-form">
                <input type="text" name="q" placeholder="Pesquisar nos salvos..." class="search-input" value="{{ request.GET.q|default:'' }}">
                <button type="submit" class="search-btn-icon"><i class="fas fa-search"></i></button>
            </form>
            
            <button class="btn-create-folder" onclick="openCreateModal(false)" title="Criar nova coleção">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="section-header">
            <h3 class="section-title">Minhas Coleções</h3>
        </div>

        <div class="collections-scroll" id="collections-container">
            <div class="collection-card" onclick="openCreateModal(false)">
                <div class="collection-thumb-box create-collection-box">
                    <i class="fas fa-plus"></i>
                </div>
                <h4 class="collection-name">Nova coleção</h4>
            </div>

            </div>

        <div class="section-header">
            <h3 class="section-title">Todos os Itens</h3>
            {% if noticias_salvas %}
            <button class="btn-toggle-select" id="btn-toggle-select" onclick="toggleSelectionMode()">
                Selecionar
            </button>
            {% endif %}
        </div>

        <div class="news-grid">
            {% if noticias_salvas %}
                {% for noticia in noticias_salvas %}
                <div class="news-card js-card-item" data-id="{{ noticia.pk }}" onclick="handleCardClick(this, '{{ noticia.pk }}')">
                    
                    <div class="selection-check"></div>

                    {% if noticia.imagem %}
                        <img src="{{ noticia.imagem.url }}" alt="{{ noticia.titulo }}" class="card-img">
                    {% else %}
                        <div style="height:100%; display:flex; align-items:center; justify-content:center; background:#e0e0e0; color:#999;">
                            <i class="fas fa-newspaper fa-2x"></i>
                        </div>
                    {% endif %}
                    
                    <div class="card-overlay">
                        <h3 class="card-title">{{ noticia.titulo }}</h3>
                    </div>
                    
                    <a href="{% url 'Echo_app:noticia_detalhe' pk=noticia.pk %}" class="real-link" style="display:none;"></a>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state-container">
                    <div class="empty-icon-circle">
                        <i class="far fa-bookmark"></i>
                    </div>
                    <h4 class="empty-title">Nenhum item salvo ainda</h4>
                    <p class="empty-desc">Toque no ícone de salvar nas notícias que você gosta para vê-las aqui.</p>
                    <a href="{% url 'Echo_app:dashboard' %}" class="btn-empty-action">Explorar notícias</a>
                </div>
            {% endif %}
        </div>

    </div>
</div>

<div class="floating-action-bar">
    <span class="selected-count" id="count-display">0 selecionados</span>
    <button class="btn-action-float" id="btn-create-with-items" onclick="openCreateModal(true)" disabled>
        <i class="fas fa-folder-plus"></i> Criar Coleção
    </button>
</div>

<div id="modal-nova-colecao" class="modal-overlay">
    <div class="modal-box">
        <h3 class="modal-title" id="modal-title-text">Nova Coleção</h3>
        <p style="font-size: 0.9rem; color: #666; margin:0;" id="modal-desc-text">Nome da sua nova pasta</p>
        
        <input type="text" id="input-nome-colecao" class="modal-input" placeholder="Ex: Política, Receitas..." autofocus autocomplete="off">
        
        <div class="modal-actions">
            <button class="btn-modal btn-cancel" onclick="closeModal()">Cancelar</button>
            <button class="btn-modal btn-confirm" onclick="confirmCreateCollection()">Criar Pasta</button>
        </div>
    </div>
</div>

<script>
    let isSelectionMode = false;
    let selectedItems = new Set();
    let creatingWithItems = false;

    // Alternar Modo Seleção
    function toggleSelectionMode() {
        isSelectionMode = !isSelectionMode;
        document.body.classList.toggle('selection-mode');
        
        const btn = document.getElementById('btn-toggle-select');
        if (isSelectionMode) {
            btn.innerText = 'Cancelar';
            btn.classList.add('cancel-mode');
        } else {
            btn.innerText = 'Selecionar';
            btn.classList.remove('cancel-mode');
            selectedItems.clear();
            updateSelectionUI();
        }
    }

    // Clique no Card
    function handleCardClick(cardElement, id) {
        if (isSelectionMode) {
            if (selectedItems.has(id)) {
                selectedItems.delete(id);
                cardElement.classList.remove('selected');
            } else {
                selectedItems.add(id);
                cardElement.classList.add('selected');
            }
            updateFloatingBar();
        } else {
            // Navegação normal
            const link = cardElement.querySelector('.real-link');
            if(link) window.location.href = link.href;
        }
    }

    // Atualiza Barra Flutuante
    function updateFloatingBar() {
        const count = selectedItems.size;
        document.getElementById('count-display').innerText = `${count} selecionado${count !== 1 ? 's' : ''}`;
        
        const btn = document.getElementById('btn-create-with-items');
        if (count > 0) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }
    
    function updateSelectionUI() {
        document.querySelectorAll('.news-card').forEach(c => c.classList.remove('selected'));
        updateFloatingBar();
    }

    // Modal
    function openCreateModal(withItems) {
        creatingWithItems = withItems;
        const modal = document.getElementById('modal-nova-colecao');
        const title = document.getElementById('modal-title-text');
        
        if (withItems) {
            title.innerText = "Agrupar em Coleção";
        } else {
            title.innerText = "Nova Coleção";
        }

        modal.style.display = 'flex';
        const input = document.getElementById('input-nome-colecao');
        input.value = '';
        setTimeout(() => input.focus(), 100);
    }

    function closeModal() {
        document.getElementById('modal-nova-colecao').style.display = 'none';
    }
    
    // Fechar ao clicar fora
    document.getElementById('modal-nova-colecao').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    
    // Enter no input
    document.getElementById('input-nome-colecao').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') confirmCreateCollection();
    });

    // Confirmar Criação (Visual)
    function confirmCreateCollection() {
        const nome = document.getElementById('input-nome-colecao').value;
        if (!nome.trim()) return;

        const container = document.getElementById('collections-container');
        const novoCard = document.createElement('div');
        novoCard.className = 'collection-card';
        
        const qtd = creatingWithItems ? selectedItems.size : 0;
        
        // Tenta pegar imagem do primeiro item selecionado
        let capaUrl = ''; 
        let contentInner = '';
        
        if (creatingWithItems && selectedItems.size > 0) {
            const firstId = [...selectedItems][0];
            const cardDom = document.querySelector(`.js-card-item[data-id="${firstId}"]`);
            if (cardDom) {
                const img = cardDom.querySelector('img');
                if (img) capaUrl = img.src;
            }
        }
        
        if (capaUrl) {
             contentInner = `<img src="${capaUrl}" class="collection-thumb">`;
        } else {
             // Placeholder colorido com a primeira letra
             const cor = '#' + Math.floor(Math.random()*16777215).toString(16);
             contentInner = `<div style="width:100%; height:100%; background:${cor}; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; font-size:2rem;">${nome.charAt(0).toUpperCase()}</div>`;
        }

        novoCard.innerHTML = `
            <div class="collection-thumb-box">
                ${contentInner}
            </div>
            <h4 class="collection-name">${nome}</h4>
            <span class="collection-count">${qtd} itens</span>
        `;
        
        // Insere logo após o botão de criar
        if (container.children.length > 0) {
            container.insertBefore(novoCard, container.children[1]); 
        } else {
            container.appendChild(novoCard);
        }

        closeModal();
        if (creatingWithItems) {
            toggleSelectionMode();
        }
    }
</script>

{% endblock %}